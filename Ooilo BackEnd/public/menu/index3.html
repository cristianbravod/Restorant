// ==========================================
// RENDERIZADO DINÃMICO DEL MENÃš (CORREGIDO)
// ==========================================

function renderMenuDinamico(menuItems) {
    const container = document.getElementById('menu-container');
    
    if (!Array.isArray(menuItems) || menuItems.length === 0) {
        container.innerHTML = '<p class="p-4 text-center text-[#80726b]">No hay productos disponibles en este momento.</p>';
        return;
    }
    
    console.log('ğŸ”„ Renderizando menÃº dinÃ¡mico con ' + menuItems.length + ' productos...');
    
    // âœ… CORRECCIÃ“N: Filtrar solo por DISPONIBLE (segÃºn la BD)
    const productosDisponibles = menuItems.filter(function(item) {
        const disponible = esProductoDisponible(item);
        
        if (!disponible) {
            console.log('âš ï¸ Producto no disponible excluido: ' + item.nombre);
        }
        
        return disponible;
    });
    
    console.log('âœ… Productos disponibles despuÃ©s del filtro: ' + productosDisponibles.length);
    
    // Agrupar productos por categorÃ­a
    const categorias = {};
    productosDisponibles.forEach(function(item) {
        const categoria = (item.categoria_nombre || item.categoria || 'Sin CategorÃ­a').trim();
        
        if (!categorias[categoria]) {
            categorias[categoria] = {
                nombre: categoria,
                items: [],
                activa: true
            };
        }
        
        categorias[categoria].items.push(item);
    });
    
    // Filtrar categorÃ­as que tienen al menos un producto
    const categoriasConProductos = Object.values(categorias).filter(function(cat) {
        return cat.items.length > 0;
    });
    
    console.log('ğŸ“ CategorÃ­as con productos: ' + categoriasConProductos.map(function(cat) {
        return cat.nombre + ' (' + cat.items.length + ' items)';
    }).join(', '));
    
    // Ordenar categorÃ­as alfabÃ©ticamente
    categoriasConProductos.sort(function(a, b) {
        return a.nombre.localeCompare(b.nombre);
    });
    
    // Mapeo de emojis por categorÃ­a
    const emojiMap = {
        'Entradas': 'ğŸ¥—',
        'Platos Principales': 'ğŸ½ï¸',
        'Tacos': 'ğŸŒ®',
        'Pizzas': 'ğŸ•',
        'Postres': 'ğŸ°',
        'Bebidas': 'ğŸ¥¤',
        'Bebidas Calientes': 'â˜•',
        'Bebidas FrÃ­as': 'ğŸ¥¤',
        'Ensaladas': 'ğŸ¥—',
        'Carnes': 'ğŸ¥©',
        'Pescados': 'ğŸŸ',
        'Vegetariano': 'ğŸŒ±',
        'Vegano': 'ğŸŒ¿',
        'Comida': 'ğŸ´',
        'Especiales': 'â­',
        'Sin CategorÃ­a': 'ğŸ“¦'
    };
    
    let categoriasHTML = '';
    let totalProductosMostrados = 0;
    
    // Renderizar cada categorÃ­a
    categoriasConProductos.forEach(function(categoria) {
        const emoji = emojiMap[categoria.nombre] || 'ğŸ´';
        
        console.log('ğŸ“ Renderizando: ' + emoji + ' ' + categoria.nombre + ' (' + categoria.items.length + ' productos)');
        
        // Header de la categorÃ­a
        categoriasHTML += '<div class="categoria-section" data-categoria="' + categoria.nombre + '">';
        categoriasHTML += '<h2 class="text-[#161413] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">';
        categoriasHTML += emoji + ' ' + categoria.nombre;
        categoriasHTML += '<span class="categoria-count text-sm text-[#80726b] font-normal ml-2">(' + categoria.items.length + ')</span>';
        categoriasHTML += '</h2>';
        
        // Items de la categorÃ­a
        categoria.items.forEach(function(item) {
            categoriasHTML += createMenuItem(item);
            totalProductosMostrados++;
        });
        
        categoriasHTML += '</div>';
    });
    
    // Si no hay categorÃ­as con productos
    if (categoriasConProductos.length === 0) {
        categoriasHTML = '<div class="p-8 text-center">';
        categoriasHTML += '<div class="text-6xl mb-4">ğŸ½ï¸</div>';
        categoriasHTML += '<h3 class="text-xl font-bold text-[#161413] mb-2">No hay productos disponibles</h3>';
        categoriasHTML += '<p class="text-[#80726b]">Estamos actualizando nuestro menÃº. Por favor, vuelve pronto.</p>';
        categoriasHTML += '</div>';
    }
    
    container.innerHTML = categoriasHTML;
    
    // Log del resultado final
    console.log('âœ… MenÃº renderizado exitosamente:');
    console.log('   ğŸ“ ' + categoriasConProductos.length + ' categorÃ­as mostradas');
    console.log('   ğŸ½ï¸ ' + totalProductosMostrados + ' productos mostrados');
    console.log('   ğŸ“‹ CategorÃ­as: ' + categoriasConProductos.map(function(c) { return c.nombre; }).join(', '));
}

function renderPlatosEspeciales(platosEspeciales) {
    const section = document.getElementById('platos-especiales-section');
    const container = document.getElementById('platos-especiales-container');
    
    console.log('ğŸŒŸ Procesando platos especiales: ' + platosEspeciales.length);
    
    if (!platosEspeciales || platosEspeciales.length === 0) {
        console.log('ğŸ“ No hay platos especiales para mostrar');
        section.style.display = 'none';
        return;
    }
    
    // âœ… CORRECCIÃ“N: Filtrar platos especiales disponibles
    const especialesDisponibles = platosEspeciales.filter(function(plato) {
        const disponible = esProductoDisponible(plato);
        
        if (!disponible) {
            console.log('âš ï¸ Plato especial no disponible excluido: ' + plato.nombre);
        }
        
        return disponible;
    });
    
    console.log('âœ… Platos especiales disponibles: ' + especialesDisponibles.length);
    
    if (especialesDisponibles.length === 0) {
        console.log('ğŸ“ No hay platos especiales disponibles para mostrar');
        section.style.display = 'none';
        return;
    }
    
    // Limpiar y crear contenido de platos especiales
    const especialesHTML = createPlatosEspeciales(especialesDisponibles);
    container.innerHTML = especialesHTML;
    section.style.display = 'block';
    
    console.log('âœ… SecciÃ³n de platos especiales renderizada: ' + especialesDisponibles.length + ' items');
}

function createMenuItem(item, isSpecialItem) {
    isSpecialItem = isSpecialItem || false;
    
    const imageUrl = item.imagen || getDefaultImage();
    
    const isSpecial = isSpecialItem || 
                     item.es_especial === true || 
                     item.es_especial === 1 || 
                     item.categoria_nombre === 'Platos Especiales';
    
    console.log('ğŸ–¼ï¸ Creando item para ' + item.nombre + ':', {
        imagen: item.imagen,
        imageUrl_final: imageUrl,
        es_especial: isSpecial,
        disponible: item.disponible
    });
    
    let html = '';
    html += '<div class="p-4" data-item-id="' + item.id + '">';
    html += '<div class="flex items-stretch justify-between gap-4 rounded-xl">';
    html += '<div class="flex flex-col gap-1 flex-[2_2_0px]">';
    html += '<div class="flex items-center flex-wrap">';
    html += '<p class="text-[#161413] text-base font-bold leading-tight">';
    html += item.nombre + ' - <span class="price">' + formatPrice(item.precio) + '</span>';
    html += '</p>';
    
    if (item.vegetariano) {
        html += '<span class="vegetarian-badge">ğŸŒ± Vegetariano</span>';
    }
    if (item.picante) {
        html += '<span class="spicy-badge">ğŸŒ¶ï¸ Picante</span>';
    }
    
    html += '</div>';
    html += '<p class="text-[#80726b] text-sm font-normal leading-normal">';
    html += (item.descripcion || 'Deliciosa preparaciÃ³n de nuestra cocina');
    html += '</p>';
    
    if (item.ingredientes) {
        html += '<p class="text-[#95a5a6] text-xs mt-1">';
        html += '<strong>Ingredientes:</strong> ' + item.ingredientes;
        html += '</p>';
    }
    
    if (item.tiempo_preparacion) {
        html += '<p class="text-[#95a5a6] text-xs">';
        html += 'â±ï¸ Tiempo de preparaciÃ³n: ' + item.tiempo_preparacion + ' min';
        html += '</p>';
    }
    
    html += '</div>';
    html += '<div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl flex-1 item-image"';
    html += ' style="background-image: url(\'' + imageUrl + '\');"';
    
    const safeNombre = item.nombre.replace(/'/g, '&apos;');
    const safeDescripcion = (item.descripcion || '').replace(/'/g, '&apos;');
    const safeIngredientes = (item.ingredientes || '').replace(/'/g, '&apos;');
    const safeTiempo = (item.tiempo_preparacion || '');
    
    html += ' onclick="openImageModal(\'' + item.id + '\', \'' + imageUrl + '\', \'' + safeNombre + '\', \'' + item.precio + '\', \'' + safeDescripcion + '\', ' + (item.vegetariano ? 'true' : 'false') + ', ' + (item.picante ? 'true' : 'false') + ', \'' + safeIngredientes + '\', \'' + safeTiempo + '\')"';
    html += ' title="Clic para ver en detalle">';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    return html;
}

function createPlatosEspeciales(platosEspeciales) {
    if (!platosEspeciales || platosEspeciales.length === 0) {
        return '';
    }

    // Rastrear IDs de platos especiales para evitar duplicados
    platosEspeciales.forEach(function(plato) {
        if (plato.id) {
            specialItemIds.add(plato.id);
        }
    });

    console.log('ğŸŒŸ Platos especiales registrados: ' + Array.from(specialItemIds).join(', '));

    return platosEspeciales.map(function(plato) {
        return createMenuItem(plato, true);
    }).join('');
}

// ==========================================
// CARGA DE DATOS (CORREGIDA)
// ==========================================

function cargarMenu() {
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const mainContent = document.getElementById('main-content');

    // Mostrar loading
    loading.style.display = 'flex';
    errorMessage.style.display = 'none';
    mainContent.style.display = 'none';

    // Limpiar conjunto de platos especiales
    specialItemIds.clear();

    console.log('ğŸ”„ Cargando menÃº con filtro de disponibilidad...');
    
    // Intentar cargar desde endpoint web primero
    fetch('/api/menu-publico')
        .then(function(response) {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Endpoint web no disponible');
        })
        .then(function(data) {
            if (data.success && data.categorias) {
                console.log('ğŸ“Š Estructura web detectada (categorÃ­as agrupadas)');
                
                // Extraer todos los items de todas las categorÃ­as
                let menuItems = [];
                data.categorias.forEach(function(categoria) {
                    if (categoria.items && Array.isArray(categoria.items)) {
                        categoria.items.forEach(function(item) {
                            item.categoria_nombre = item.categoria_nombre || categoria.nombre;
                            item.es_especial = false;
                            menuItems.push(item);
                        });
                    }
                });
                
                const platosEspeciales = data.platos_especiales || [];
                const restauranteInfo = data.restaurante;
                
                console.log('ğŸ“‹ Estructura web procesada: ' + menuItems.length + ' items normales + ' + platosEspeciales.length + ' especiales');
                
                procesarDatos(menuItems, platosEspeciales, restauranteInfo);
            } else {
                throw new Error('Estructura de datos no vÃ¡lida');
            }
        })
        .catch(function(error) {
            console.log('âš ï¸ Endpoint web no disponible, probando /api/menu...');
            
            // Fallback al endpoint principal
            fetch('/api/menu')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (Array.isArray(data)) {
                        console.log('ğŸ“Š Estructura de array detectada');
                        
                        // Separar por flag es_especial
                        const platosEspeciales = data.filter(function(item) {
                            return item.es_especial === true || item.es_especial === 1;
                        });
                        const menuItems = data.filter(function(item) {
                            return item.es_especial !== true && item.es_especial !== 1;
                        });
                        
                        console.log('ğŸ“‹ Datos procesados: ' + menuItems.length + ' items normales + ' + platosEspeciales.length + ' especiales');
                        
                        procesarDatos(menuItems, platosEspeciales, null);
                    } else {
                        throw new Error('Estructura de datos no reconocida');
                    }
                })
                .catch(function(secondError) {
                    console.error('âŒ Error cargando menÃº:', secondError);
                    mostrarError(secondError.message);
                });
        });
}

function procesarDatos(menuItems, platosEspeciales, restauranteInfo) {
    // Log detallado de lo que se recibiÃ³
    console.log('ğŸ“Š Datos recibidos:');
    console.log('   ğŸ½ï¸ Items del menÃº normal: ' + menuItems.length);
    console.log('   â­ Platos especiales: ' + platosEspeciales.length);
    console.log('   ğŸ“¦ Total productos: ' + (menuItems.length + platosEspeciales.length));
    
    // Verificar que tenemos datos
    if (menuItems.length === 0 && platosEspeciales.length === 0) {
        throw new Error('No se recibieron productos del servidor');
    }
    
    // Debug: Verificar categorÃ­as en los datos
    if (menuItems.length > 0) {
        const categorias = [];
        const categoriasSet = new Set();
        menuItems.forEach(function(item) {
            if (item.categoria_nombre) {
                categoriasSet.add(item.categoria_nombre);
            }
        });
        const categoriasArray = Array.from(categoriasSet).filter(Boolean);
        console.log('ğŸ“ CategorÃ­as encontradas: ' + categoriasArray.join(', '));
    }
    
    // Renderizar platos especiales si los hay
    if (platosEspeciales.length > 0) {
        renderPlatosEspeciales(platosEspeciales);
        console.log('â­ Platos especiales procesados');
    } else {
        // Ocultar secciÃ³n de especiales si no hay
        const section = document.getElementById('platos-especiales-section');
        if (section) {
            section.style.display = 'none';
        }
        console.log('ğŸ“ No hay platos especiales para mostrar');
    }
    
    // Renderizar menÃº principal
    renderMenuDinamico(menuItems);
    
    // Actualizar informaciÃ³n del restaurante
    updateRestaurantContact(restauranteInfo);
    
    // Actualizar timestamp
    document.getElementById('last-updated').textContent = 
        'Ãšltima actualizaciÃ³n: ' + new Date().toLocaleString('es-CL');
    
    // Mostrar contenido
    const loading = document.getElementById('loading');
    const mainContent = document.getElementById('main-content');
    loading.style.display = 'none';
    mainContent.style.display = 'flex';
    
    console.log('âœ… MenÃº cargado exitosamente con filtro de disponibilidad');
}

function mostrarError(mensaje) {
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    
    loading.style.display = 'none';
    errorMessage.style.display = 'block';
    
    const errorText = errorMessage.querySelector('p');
    if (errorText) {
        errorText.textContent = 'Error: ' + mensaje + '. Por favor, intÃ©ntalo mÃ¡s tarde.';
    }
}

// ==========================================
// FUNCIÃ“N DE DEBUG PARA DISPONIBILIDAD
// ==========================================

function debugMenuDisponibilidad() {
    console.log('ğŸ” === DEBUG FILTRO DE DISPONIBILIDAD ===');
    
    fetch('/api/menu')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            console.log('ğŸ“¡ Respuesta de /api/menu:');
            console.log('   ğŸ“Š Tipo: ' + (Array.isArray(data) ? 'Array' : typeof data));
            console.log('   ğŸ“¦ Cantidad total: ' + (Array.isArray(data) ? data.length : 'N/A'));
            
            if (Array.isArray(data)) {
                // Analizar por disponibilidad
                const disponibles = data.filter(function(item) {
                    return esProductoDisponible(item);
                });
                const noDisponibles = data.filter(function(item) {
                    return !esProductoDisponible(item);
                });
                
                console.log('   ğŸŸ¢ Productos disponibles: ' + disponibles.length);
                console.log('   ğŸ”´ Productos no disponibles: ' + noDisponibles.length);
                
                if (noDisponibles.length > 0) {
                    console.log('ğŸ“‹ Productos no disponibles:');
                    noDisponibles.forEach(function(item) {
                        console.log('  - ' + item.nombre + ' (disponible: ' + item.disponible + ')');
                    });
                }
                
                // Analizar por categorÃ­as
                const categorias = {};
                disponibles.forEach(function(item) {
                    const cat = item.categoria_nombre || 'Sin categorÃ­a';
                    if (!categorias[cat]) categorias[cat] = 0;
                    categorias[cat]++;
                });
                
                console.log('ğŸ“ Productos disponibles por categorÃ­a:');
                Object.entries(categorias).forEach(function([cat, count]) {
                    console.log('  - ' + cat + ': ' + count + ' productos');
                });
            }
        })
        .catch(function(error) {
            console.error('âŒ Error en debug: ' + error.message);
        });
}

// ==========================================
// NAVEGACIÃ“N MÃ“VIL
// ==========================================

function setActiveNavItem(clickedItem) {
    // Remover active de todos los items
    const navItems = document.querySelectorAll('.mobile-nav-item');
    navItems.forEach(function(item) {
        item.classList.remove('active');
    });
    
    // Agregar active al item clickeado
    clickedItem.classList.add('active');
}ando menÃº dinÃ¡mico con ' + menuItems.length + ' productos...');
    
    // âœ… CORRECCIÃ“N: Filtrar por VIGENTE y DISPONIBLE
    const productosVigentesYDisponibles = menuItems.filter(function(item) {
        // Verificar que el producto estÃ© vigente (no eliminado lÃ³gicamente)
        const vigente = esProductoVigente(item);
        // Verificar que el producto estÃ© disponible
        const disponible = esProductoDisponible(item);
        
        if (!vigente) {
            console.log('ğŸ—‘ï¸ Producto eliminado lÃ³gicamente (vigente=false) excluido: ' + item.nombre);
        }
        if (!disponible) {
            console.log('âš ï¸ Producto no disponible excluido: ' + item.nombre);
        }
        
        return vigente && disponible;
    });
    
    console.log('âœ… Productos vigentes y disponibles despuÃ©s del filtro: ' + productosVigentesYDisponibles.length);
    
    // Agrupar productos por categorÃ­a
    const categorias = {};
    productosVigentesYDisponibles.forEach(function(item) {
        const categoria = (item.categoria_nombre || item.categoria || 'Sin CategorÃ­a').trim();
        
        if (!categorias[categoria]) {
            categorias[categoria] = {
                nombre: categoria,
                items: [],
                activa: true
            };
        }
        
        categorias[categoria].items.push(item);
    });
    
    // Filtrar categorÃ­as que tienen al menos un producto
    const categoriasConProductos = Object.values(categorias).filter(function(cat) {
        return cat.items.length > 0;
    });
    
    console.log('ğŸ“ CategorÃ­as con productos: ' + categoriasConProductos.map(function(cat) {
        return cat.nombre + ' (' + cat.items.length + ' items)';
    }).join(', '));
    
    // Ordenar categorÃ­as alfabÃ©ticamente
    categoriasConProductos.sort(function(a, b) {
        return a.nombre.localeCompare(b.nombre);
    });
    
    // Mapeo de emojis por categorÃ­a
    const emojiMap = {
        'Entradas': 'ğŸ¥—',
        'Platos Principales': 'ğŸ½ï¸',
        'Tacos': 'ğŸŒ®',
        'Pizzas': 'ğŸ•',
        'Postres': 'ğŸ°',
        'Bebidas': 'ğŸ¥¤',
        'Bebidas Calientes': 'â˜•',
        'Bebidas FrÃ­as': 'ğŸ¥¤',
        'Ensaladas': 'ğŸ¥—',
        'Carnes': 'ğŸ¥©',
        'Pescados': 'ğŸŸ',
        'Vegetariano': 'ğŸŒ±',
        'Vegano': 'ğŸŒ¿',
        'Comida': 'ğŸ´',
        'Especiales': 'â­',
        'Sin CategorÃ­a': 'ğŸ“¦'
    };
    
    let categoriasHTML = '';
    let totalProductosMostrados = 0;
    
    // Renderizar cada categorÃ­a
    categoriasConProductos.forEach(function(categoria) {
        const emoji = emojiMap[categoria.nombre] || 'ğŸ´';
        
        console.log('ğŸ“ Renderizando: ' + emoji + ' ' + categoria.nombre + ' (' + categoria.items.length + ' productos)');
        
        // Header de la categorÃ­a
        categoriasHTML += '<div class="categoria-section" data-categoria="' + categoria.nombre + '">';
        categoriasHTML += '<h2 class="text-[#161413] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">';
        categoriasHTML += emoji + ' ' + categoria.nombre;
        categoriasHTML += '<span class="categoria-count text-sm text-[#80726b] font-normal ml-2">(' + categoria.items.length + ')</span>';
        categoriasHTML += '</h2>';
        
        // Items de la categorÃ­a
        categoria.items.forEach(function(item) {
            categoriasHTML += createMenuItem(item);
            totalProductosMostrados++;
        });
        
        categoriasHTML += '</div>';
    });
    
    // Si no hay categorÃ­as con productos
    if (categoriasConProductos.length === 0) {
        categoriasHTML = '<div class="p-8 text-center">';
        categoriasHTML += '<div class="text-6xl mb-4">ğŸ½ï¸</div>';
        categoriasHTML += '<h3 class="text-xl font-bold text-[#161413] mb-2">No hay productos disponibles</h3>';
        categoriasHTML += '<p class="text-[#80726b]">Estamos actualizando nuestro menÃº. Por favor, vuelve pronto.</p>';
        categoriasHTML += '</div>';
    }
    
    container.innerHTML = categoriasHTML;
    
    // Log del resultado final
    console.log('âœ… MenÃº renderizado exitosamente:');
    console.log('   ğŸ“ ' + categoriasConProductos.length + ' categorÃ­as mostradas');
    console.log('   ğŸ½ï¸ ' + totalProductosMostrados + ' productos mostrados');
    console.log('   ğŸ“‹ CategorÃ­as: ' + categoriasConProductos.map(function(c) { return c.nombre; }).join(', '));
}

function renderPlatosEspeciales(platosEspeciales) {
    const section = document.getElementById('platos-especiales-section');
    const container = document.getElementById('platos-especiales-container');
    
    console.log('ğŸŒŸ Procesando platos especiales: ' + platosEspeciales.length);
    
    if (!platosEspeciales || platosEspeciales.length === 0) {
        console.log('ğŸ“ No hay platos especiales para mostrar');
        section.style.display = 'none';
        return;
    }
    
    // âœ… CORRECCIÃ“N: Filtrar platos especiales vigentes y disponibles
    const especialesVigentesYDisponibles = platosEspeciales.filter(function(plato) {
        // Verificar que el plato estÃ© vigente (no eliminado lÃ³gicamente)
        const vigente = esProductoVigente(plato);
        // Verificar que el plato estÃ© disponible
        const disponible = esProductoDisponible(plato);
        
        if (!vigente) {
            console.log('ğŸ—‘ï¸ Plato especial eliminado lÃ³gicamente (vigente=false) excluido: ' + plato.nombre);
        }
        if (!disponible) {
            console.log('âš ï¸ Plato especial no disponible excluido: ' + plato.nombre);
        }
        
        return vigente && disponible;
    });
    
    console.log('âœ… Platos especiales vigentes y disponibles: ' + especialesVigentesYDisponibles.length);
    
    if (especialesVigentesYDisponibles.length === 0) {
        console.log('ğŸ“ No hay platos especiales vigentes y disponibles para mostrar');
        section.style.display = 'none';
        return;
    }
    
    // Limpiar y crear contenido de platos especiales
    const especialesHTML = createPlatosEspeciales(especialesVigentesYDisponibles);
    container.innerHTML = especialesHTML;
    section.style.display = 'block';
    
    console.log('âœ… SecciÃ³n de platos especiales renderizada: ' + especialesVigentesYDisponibles.length + ' items');
}

function createMenuItem(item, isSpecialItem) {
    isSpecialItem = isSpecialItem || false;
    
    const imageUrl = item.imagen_url || item.imagen || getDefaultImage();
    
    const isSpecial = isSpecialItem || 
                     item.es_especial || 
                     item.categoria_nombre === 'Platos Especiales';
    
    console.log('ğŸ–¼ï¸ Imagen para ' + item.nombre + ':', {
        imagen_url: item.imagen_url,
        imagen: item.imagen,
        imageUrl_final: imageUrl,
        es_especial: isSpecial
    });
    
    let html = '';
    html += '<div class="p-4" data-item-id="' + item.id + '">';
    html += '<div class="flex items-stretch justify-between gap-4 rounded-xl">';
    html += '<div class="flex flex-col gap-1 flex-[2_2_0px]">';
    html += '<div class="flex items-center flex-wrap">';
    html += '<p class="text-[#161413] text-base font-bold leading-tight">';
    html += item.nombre + ' - <span class="price">' + formatPrice(item.precio) + '</span>';
    html += '</p>';
    
    if (item.vegetariano) {
        html += '<span class="vegetarian-badge">ğŸŒ± Vegetariano</span>';
    }
    if (item.picante) {
        html += '<span class="spicy-badge">ğŸŒ¶ï¸ Picante</span>';
    }
    
    html += '</div>';
    html += '<p class="text-[#80726b] text-sm font-normal leading-normal">';
    html += (item.descripcion || 'Deliciosa preparaciÃ³n de nuestra cocina');
    html += '</p>';
    
    if (item.ingredientes) {
        html += '<p class="text-[#95a5a6] text-xs mt-1">';
        html += '<strong>Ingredientes:</strong> ' + item.ingredientes;
        html += '</p>';
    }
    
    if (item.tiempo_preparacion) {
        html += '<p class="text-[#95a5a6] text-xs">';
        html += 'â±ï¸ Tiempo de preparaciÃ³n: ' + item.tiempo_preparacion + ' min';
        html += '</p>';
    }
    
    html += '</div>';
    html += '<div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl flex-1 item-image"';
    html += ' style="background-image: url(\'' + imageUrl + '\');"';
    
    const safeNombre = item.nombre.replace(/'/g, '&apos;');
    const safeDescripcion = (item.descripcion || '').replace(/'/g, '&apos;');
    const safeIngredientes = (item.ingredientes || '').replace(/'/g, '&apos;');
    const safeTiempo = (item.tiempo_preparacion || '');
    
    html += ' onclick="openImageModal(\'' + item.id + '\', \'' + imageUrl + '\', \'' + safeNombre + '\', \'' + item.precio + '\', \'' + safeDescripcion + '\', ' + (item.vegetariano ? 'true' : 'false') + ', ' + (item.picante ? 'true' : 'false') + ', \'' + safeIngredientes + '\', \'' + safeTiempo + '\')"';
    html += ' title="Clic para ver en detalle">';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    return html;
}

function createPlatosEspeciales(platosEspeciales) {
    if (!platosEspeciales || platosEspeciales.length === 0) {
        return '';
    }

    // Rastrear IDs de platos especiales para evitar duplicados
    platosEspeciales.forEach(function(plato) {
        if (plato.id) {
            specialItemIds.add(plato.id);
        }
    });

    console.log('ğŸŒŸ Platos especiales registrados: ' + Array.from(specialItemIds).join(', '));

    return platosEspeciales.map(function(plato) {
        return createMenuItem(plato, true);
    }).join('');
}

// ==========================================
// CARGA DE DATOS
// ==========================================

function cargarMenu() {
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const mainContent = document.getElementById('main-content');

    // Mostrar loading
    loading.style.display = 'flex';
    errorMessage.style.display = 'none';
    mainContent.style.display = 'none';

    // Limpiar conjunto de platos especiales
    specialItemIds.clear();

    console.log('ğŸ”„ Cargando menÃº con sistema dinÃ¡mico (UNION de tablas + filtro vigente)...');
    
    // Intentar cargar desde endpoint web primero
    fetch('/api/menu-publico')
        .then(function(response) {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Endpoint web no disponible');
        })
        .then(function(data) {
            if (data.success && data.categorias) {
                console.log('ğŸ“Š Estructura web detectada (categorÃ­as agrupadas)');
                
                // Extraer todos los items de todas las categorÃ­as
                let menuItems = [];
                data.categorias.forEach(function(categoria) {
                    if (categoria.items && Array.isArray(categoria.items)) {
                        categoria.items.forEach(function(item) {
                            item.categoria_nombre = item.categoria_nombre || categoria.nombre;
                            item.es_especial = false;
                            menuItems.push(item);
                        });
                    }
                });
                
                const platosEspeciales = data.platos_especiales || [];
                const restauranteInfo = data.restaurante;
                
                console.log('ğŸ“‹ Estructura web procesada: ' + menuItems.length + ' items normales de ' + data.categorias.length + ' categorÃ­as + ' + platosEspeciales.length + ' especiales');
                
                procesarDatos(menuItems, platosEspeciales, restauranteInfo);
            } else {
                throw new Error('Estructura de datos no vÃ¡lida');
            }
        })
        .catch(function(error) {
            console.log('âš ï¸ Endpoint web no disponible, probando /api/menu (UNION)...');
            
            // Fallback al endpoint UNION
            fetch('/api/menu')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (Array.isArray(data)) {
                        console.log('ğŸ“Š Estructura UNION detectada (array con flag es_especial)');
                        
                        // Separar por flag es_especial
                        const platosEspeciales = data.filter(function(item) {
                            return item.es_especial === true;
                        });
                        const menuItems = data.filter(function(item) {
                            return item.es_especial !== true;
                        });
                        
                        console.log('ğŸ“‹ Estructura UNION procesada: ' + menuItems.length + ' items normales + ' + platosEspeciales.length + ' especiales');
                        
                        procesarDatos(menuItems, platosEspeciales, null);
                    } else {
                        throw new Error('Estructura de datos no reconocida');
                    }
                })
                .catch(function(secondError) {
                    console.error('âŒ Error cargando menÃº dinÃ¡mico:', secondError);
                    mostrarError(secondError.message);
                });
        });
}

function procesarDatos(menuItems, platosEspeciales, restauranteInfo) {
    // Log detallado de lo que se recibiÃ³
    console.log('ğŸ“Š Datos recibidos (despuÃ©s de UNION):');
    console.log('   ğŸ½ï¸ Items del menÃº normal: ' + menuItems.length);
    console.log('   â­ Platos especiales: ' + platosEspeciales.length);
    console.log('   ğŸ“¦ Total productos: ' + (menuItems.length + platosEspeciales.length));
    
    // âœ… NUEVO: Analizar vigencia antes del filtrado
    console.log('ğŸ” Analizando vigencia de productos:');
    
    const menuVigentes = menuItems.filter(esProductoVigente);
    const menuNoVigentes = menuItems.filter(item => !esProductoVigente(item));
    const especialesVigentes = platosEspeciales.filter(esProductoVigente);
    const especialesNoVigentes = platosEspeciales.filter(item => !esProductoVigente(item));
    
    console.log('   ğŸ½ï¸ MenÃº normal - Vigentes: ' + menuVigentes.length + ' | No vigentes: ' + menuNoVigentes.length);
    console.log('   â­ Especiales - Vigentes: ' + especialesVigentes.length + ' | No vigentes: ' + especialesNoVigentes.length);
    
    // Mostrar productos eliminados lÃ³gicamente
    if (menuNoVigentes.length > 0) {
        console.log('ğŸ—‘ï¸ Productos del menÃº eliminados lÃ³gicamente:');
        menuNoVigentes.forEach(item => {
            console.log('  - ' + item.nombre + ' (vigente: ' + item.vigente + ')');
        });
    }
    
    if (especialesNoVigentes.length > 0) {
        console.log('ğŸ—‘ï¸ Platos especiales eliminados lÃ³gicamente:');
        especialesNoVigentes.forEach(item => {
            console.log('  - ' + item.nombre + ' (vigente: ' + item.vigente + ')');
        });
    }
    
    // Verificar que tenemos datos vigentes
    if (menuVigentes.length === 0 && especialesVigentes.length === 0) {
        console.warn('âš ï¸ No hay productos vigentes para mostrar');
        // Continuar con los datos originales para evitar pantalla vacÃ­a
    }
    
    // Renderizar platos especiales si los hay
    if (platosEspeciales.length > 0) {
        renderPlatosEspeciales(platosEspeciales);
        console.log('â­ ' + platosEspeciales.length + ' platos especiales procesados (filtrado por vigencia aplicado)');
    } else {
        // Ocultar secciÃ³n de especiales si no hay
        const section = document.getElementById('platos-especiales-section');
        if (section) {
            section.style.display = 'none';
        }
        console.log('ğŸ“ No hay platos especiales para mostrar');
    }
    
    // Renderizar menÃº principal de forma dinÃ¡mica
    renderMenuDinamico(menuItems);
    
    // Actualizar informaciÃ³n del restaurante
    updateRestaurantContact(restauranteInfo);
    
    // Actualizar timestamp
    document.getElementById('last-updated').textContent = 
        'Ãšltima actualizaciÃ³n: ' + new Date().toLocaleString('es-CL');
    
    // Mostrar contenido
    const loading = document.getElementById('loading');
    const mainContent = document.getElementById('main-content');
    loading.style.display = 'none';
    mainContent.style.display = 'flex';
    
    console.log('âœ… MenÃº dinÃ¡mico cargado exitosamente con filtro de vigencia aplicado');
}

function mostrarError(mensaje) {
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    
    loading.style.display = 'none';
    errorMessage.style.display = 'block';
    
    const errorText = errorMessage.querySelector('p');
    if (errorText) {
        errorText.textContent = 'Error: ' + mensaje + '. Por favor, intÃ©ntalo mÃ¡s tarde.';
    }
}

// ==========================================
// FUNCIÃ“N DE DEBUG PARA VERIFICAR FILTRADO
// ==========================================

function debugFiltradoVigente() {
    console.log('ğŸ” === DEBUG FILTRADO POR VIGENTE ===');
    
    fetch('/api/menu')
        .then(r => r.json())
        .then(data => {
            if (Array.isArray(data)) {
                console.log('ğŸ“Š Total de productos en API: ' + data.length);
                
                // Analizar por vigencia
                const vigentes = data.filter(esProductoVigente);
                const noVigentes = data.filter(item => !esProductoVigente(item));
                
                console.log('âœ… Productos vigentes: ' + vigentes.length);
                console.log('ğŸ—‘ï¸ Productos no vigentes (eliminados): ' + noVigentes.length);
                
                // Mostrar productos no vigentes
                if (noVigentes.length > 0) {
                    console.log('ğŸ“‹ Productos eliminados lÃ³gicamente:');
                    noVigentes.forEach(item => {
                        console.log('  - ' + item.nombre + ' (vigente: ' + item.vigente + ')');
                    });
                }
                
                // Analizar por disponibilidad
                const disponibles = vigentes.filter(esProductoDisponible);
                const noDisponibles = vigentes.filter(item => !esProductoDisponible(item));
                
                console.log('ğŸŸ¢ Productos vigentes Y disponibles: ' + disponibles.length);
                console.log('ğŸ”´ Productos vigentes pero NO disponibles: ' + noDisponibles.length);
                
                // Mostrar productos no disponibles
                if (noDisponibles.length > 0) {
                    console.log('ğŸ“‹ Productos vigentes pero no disponibles:');
                    noDisponibles.forEach(item => {
                        console.log('  - ' + item.nombre + ' (disponible: ' + item.disponible + ')');
                    });
                }
            }
        })
        .catch(error => {
            console.error('âŒ Error en debug: ' + error.message);
        });
}

// ==========================================
// NAVEGACIÃ“N MÃ“VIL
// ==========================================

function setActiveNavItem(clickedItem) {
    // Remover active de todos los items
    const navItems = document.querySelectorAll('.mobile-nav-item');
    navItems.forEach(function(item) {
        item.classList.remove('active');
    });
    
    // Agregar active al item clickeado
    clickedItem.classList.add('active');
}